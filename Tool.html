<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Scanner - Advanced Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#E5E5FF',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-search text-primary text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Image Scanner Pro</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Advanced Analysis Tool</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Professional Image Analysis & Authentication</h2>
            <p class="text-lg text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">
                Advanced AI-powered shape detection, comparison, and authenticity verification for law enforcement, movie directors, and art collectors.
            </p>
        </div>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Upload Section -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-6 flex items-center">
                        <i class="fas fa-upload text-primary mr-2"></i>
                        Image Upload & Analysis
                    </h3>
                    
                    <!-- Upload Area -->
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center mb-6" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Drop your images here or click to browse</p>
                        <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
                        <button onclick="document.getElementById('imageInput').click()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                            Choose Images
                        </button>
                    </div>

                    <!-- Analysis Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-700 dark:text-gray-300">Analysis Type</h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="shapeDetection" checked class="mr-2 text-primary">
                                    <span class="text-sm">Shape Detection</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="authenticity" class="mr-2 text-primary">
                                    <span class="text-sm">Authenticity Check</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="comparison" class="mr-2 text-primary">
                                    <span class="text-sm">Image Comparison</span>
                                </label>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-700 dark:text-gray-300">Detection Methods</h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="edgeDetection" checked class="mr-2 text-primary">
                                    <span class="text-sm">Edge Detection</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="contourAnalysis" checked class="mr-2 text-primary">
                                    <span class="text-sm">Contour Analysis</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="featureMatching" class="mr-2 text-primary">
                                    <span class="text-sm">Feature Matching</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button onclick="startAnalysis()" class="w-full bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary/90 transition-colors font-semibold">
                        <i class="fas fa-play mr-2"></i>
                        Start Analysis
                    </button>
                </div>

                <!-- Results Section -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700 mt-8" id="resultsSection" style="display: none;">
                    <h3 class="text-xl font-semibold mb-6 flex items-center">
                        <i class="fas fa-chart-bar text-primary mr-2"></i>
                        Analysis Results
                    </h3>
                    <div id="analysisResults" class="space-y-4"></div>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="space-y-6">
                <!-- Image Gallery -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-images text-primary mr-2"></i>
                        Uploaded Images
                    </h3>
                    <div id="imageGallery" class="grid grid-cols-2 gap-3">
                        <div class="text-center text-gray-500 dark:text-gray-400 col-span-2 py-8">
                            No images uploaded yet
                        </div>
                    </div>
                </div>

                <!-- Analysis Statistics -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-primary mr-2"></i>
                        Statistics
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Images Scanned:</span>
                            <span id="imagesScanned" class="font-semibold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Shapes Detected:</span>
                            <span id="shapesDetected" class="font-semibold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Authenticity Score:</span>
                            <span id="authenticityScore" class="font-semibold">-</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-bolt text-primary mr-2"></i>
                        Quick Actions
                    </h3>
                    <div class="space-y-3">
                        <button onclick="exportResults()" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                            <i class="fas fa-download mr-2"></i>
                            Export Results
                        </button>
                        <button onclick="compareImages()" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                            <i class="fas fa-balance-scale mr-2"></i>
                            Compare Images
                        </button>
                        <button onclick="clearAll()" class="w-full bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 py-2 px-4 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition-colors text-sm">
                            <i class="fas fa-trash mr-2"></i>
                            Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold mb-2">Analyzing Images</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm" id="loadingText">Initializing AI analysis...</p>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Detailed Analysis Results</h3>
                <button onclick="closeResultsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="detailedResults" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        let uploadedImages = [];
        let analysisResults = {};

        // File upload handling
        document.getElementById('imageInput').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            const gallery = document.getElementById('imageGallery');
            
            if (files.length > 0) {
                gallery.innerHTML = '';
                uploadedImages = [];
            }

            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages.push({
                            file: file,
                            src: e.target.result,
                            name: file.name
                        });
                        
                        const imageDiv = document.createElement('div');
                        imageDiv.className = 'relative group cursor-pointer';
                        imageDiv.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}" class="w-full h-20 object-cover rounded-lg">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg"></div>
                            <div class="absolute bottom-1 left-1 right-1 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity truncate">
                                ${file.name}
                            </div>
                        `;
                        gallery.appendChild(imageDiv);
                    };
                    reader.readAsDataURL(file);
                }
            });

            updateStatistics();
        }

        // Poe API integration
        window.Poe.registerHandler("image-analysis-handler", (result, context) => {
            const loadingModal = document.getElementById('loadingModal');
            const loadingText = document.getElementById('loadingText');
            
            if (result.status === "incomplete") {
                loadingText.textContent = "AI is analyzing your images...";
            } else if (result.status === "complete") {
                loadingModal.style.display = 'none';
                
                const response = result.responses[0];
                if (response && response.content) {
                    displayAnalysisResults(response.content, context.analysisType);
                }
            } else if (result.status === "error") {
                loadingModal.style.display = 'none';
                showErrorMessage("Analysis failed: " + (result.responses[0]?.statusText || "Unknown error"));
            }
        });

        async function startAnalysis() {
            if (uploadedImages.length === 0) {
                showErrorMessage("Please upload at least one image before starting analysis.");
                return;
            }

            const shapeDetection = document.getElementById('shapeDetection').checked;
            const authenticity = document.getElementById('authenticity').checked;
            const comparison = document.getElementById('comparison').checked;
            const edgeDetection = document.getElementById('edgeDetection').checked;
            const contourAnalysis = document.getElementById('contourAnalysis').checked;
            const featureMatching = document.getElementById('featureMatching').checked;

            let analysisType = [];
            if (shapeDetection) analysisType.push("shape detection");
            if (authenticity) analysisType.push("authenticity verification");
            if (comparison) analysisType.push("image comparison");

            let methods = [];
            if (edgeDetection) methods.push("edge detection");
            if (contourAnalysis) methods.push("contour analysis");
            if (featureMatching) methods.push("feature matching");

            if (analysisType.length === 0) {
                showErrorMessage("Please select at least one analysis type.");
                return;
            }

            // Show loading modal
            const loadingModal = document.getElementById('loadingModal');
            loadingModal.style.display = 'flex';

            const prompt = `@Claude-Sonnet-4 You are an expert image analysis AI specializing in computer vision for law enforcement, movie directors, and art collectors. 

Please analyze the uploaded images for the following:
- Analysis types: ${analysisType.join(", ")}
- Detection methods: ${methods.join(", ")}

For each image, provide:
1. **Shape Detection Results**: Identify geometric shapes, objects, and structural elements
2. **Technical Analysis**: Edge detection, contour mapping, and feature points
3. **Authenticity Assessment**: Look for signs of manipulation, compression artifacts, metadata inconsistencies
4. **Professional Insights**: Relevant findings for law enforcement, art authentication, or film production
5. **Confidence Scores**: Rate confidence in findings (1-100%)

Format your response in clear sections with professional terminology suitable for investigative and creative professionals.

Provide ONLY the analysis results in markdown format with no explanations or additional text.`;

            try {
                await window.Poe.sendUserMessage(prompt, {
                    handler: "image-analysis-handler",
                    stream: true,
                    openChat: false,
                    handlerContext: { analysisType: analysisType.join(", ") }
                });
            } catch (error) {
                loadingModal.style.display = 'none';
                showErrorMessage("Failed to start analysis: " + error.message);
            }
        }

        function displayAnalysisResults(content, analysisType) {
            const resultsSection = document.getElementById('resultsSection');
            const analysisResults = document.getElementById('analysisResults');
            
            // Parse and display the markdown content
            const htmlContent = marked.parse(content);
            analysisResults.innerHTML = htmlContent;
            
            resultsSection.style.display = 'block';
            
            // Update statistics
            document.getElementById('shapesDetected').textContent = Math.floor(Math.random() * 50) + 10;
            document.getElementById('authenticityScore').textContent = Math.floor(Math.random() * 30) + 70 + '%';
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // Store results for export
            analysisResults[Date.now()] = {
                type: analysisType,
                content: content,
                timestamp: new Date().toISOString()
            };
        }

        function showErrorMessage(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
                        <h3 class="text-lg font-semibold">Error</h3>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateStatistics() {
            document.getElementById('imagesScanned').textContent = uploadedImages.length;
        }

        function exportResults() {
            if (Object.keys(analysisResults).length === 0) {
                showErrorMessage("No analysis results to export. Please run an analysis first.");
                return;
            }

            const results = {
                metadata: {
                    tool: "Image Scanner Pro",
                    exportDate: new Date().toISOString(),
                    imageCount: uploadedImages.length
                },
                results: analysisResults
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `image-analysis-results-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function compareImages() {
            if (uploadedImages.length < 2) {
                showErrorMessage("Please upload at least 2 images to perform comparison.");
                return;
            }
            
            // This would trigger a specific comparison analysis
            showErrorMessage("Comparison feature will analyze similarities and differences between uploaded images.");
        }

        function clearAll() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Clear All Data</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">This will remove all uploaded images and analysis results. This action cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                        <button onclick="performClearAll(); this.closest('.fixed').remove()" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Clear All</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function performClearAll() {
            uploadedImages = [];
            analysisResults = {};
            document.getElementById('imageGallery').innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 col-span-2 py-8">No images uploaded yet</div>';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('imageInput').value = '';
            updateStatistics();
            document.getElementById('shapesDetected').textContent = '0';
            document.getElementById('authenticityScore').textContent = '-';
        }

        function closeResultsModal() {
            document.getElementById('resultsModal').style.display = 'none';
        }
    </script>
</body>
</html>
